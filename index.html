<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>>>>Chatüì¢Room<<<</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

    :root {
      --bg:#010208;
      --muted:#09113c;
      --accent1:#6969d1;
      --accent2:#7698e2;
      --me-gradient:linear-gradient(135deg,#8388b8,#0d2f5c);
    }

    *{box-sizing:border-box;}
    body,html{margin:0;height:100%;font-family:'Inter',sans-serif;background:var(--bg);color:#061827;}
    .container{display:flex;flex-direction:column;height:100vh;}

   header {
  padding: 10px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  box-shadow: 0 2px 10px rgba(136, 136, 184, 0.5);
}

/* Logo */
.chat-logo {
  width: 60px;
  height: 60px;
  margin-right:2px;
}
.system-msg {
  text-align: center;
  font-size: 0.85em;
  color: #aaa;
  margin: 8px 0;
  opacity: 0.8;
  font-style: italic;
}

/* Chatroom name link */
.chatroom-link {
  font-size: 1.2em;
  font-weight: 700;
  text-decoration: none;
  background: linear-gradient(135deg, var(--accent1), var(--accent2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  position: relative;
  padding-bottom: 4px;
  transition: all 0.3s ease;
  cursor: pointer;
}

/* Animated underline */
.chatroom-link::after {
  content: "";
  position: absolute;
  left: 0;
  bottom: 0;
  width: 100%;
  height: 3px;
  background: linear-gradient(135deg, var(--accent2), var(--accent1));
  transform: scaleX(0);
  transform-origin: right;
  transition: transform 0.3s ease;
}

.chatroom-link:hover::after {
  transform: scaleX(1);
  transform-origin: left;
}

/* Hover effect: slightly enlarge and shadow */
.chatroom-link:hover {
  transform: scale(1.05);
  text-shadow: 0 0 6px rgb(16, 1, 1);
}

/* Adjust buttons */
header button {
  border:none;
  padding:8px 14px;
  border-radius:6px;
  background:linear-gradient(135deg,var(--accent1),var(--accent2));
  color:#963434;
  font-weight:600;
  cursor:pointer;
  margin-top:4px;
}
    /* Instructions */
    #instructions{
      max-height:0;overflow:hidden;
      transition:max-height 0.4s ease,padding 0.3s ease;
      padding:auto;background:rgb(236, 225, 225);
      border-bottom:auto solid rgba(20, 3, 3);
    }
    #instructions.open{max-height:300px;padding:12px;font-size:0.4em;line-height:1;}

    /* Setup */
    .setup{
      padding:12px;background:linear-gradient(#2d3fc7);
      display:flex;gap:8px;flex-wrap:wrap;
    }
    .setup input{
      flex:1;min-width:120px;padding:10px 14px;border-radius:8px;border:none;
      background:rgb(12, 6, 6);color:#fff;
    }
    .setup input::placeholder{color:#cbd5e1;}
    .setup button{
      padding:10px 16px;border:none;border-radius:8px;
      background:linear-gradient(135deg,var(--accent1),var(--accent2));
      color:#fff;font-weight:600;cursor:pointer;
    }

    /* Room header */
    .room-header{
      padding:14px;text-align:center;font-weight:600;
      background:rgba(255,255,255,0.05);
      display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap;
      overflow-x:auto;
    }
    .room-header span{color:var(--accent2);font-weight:700;}
    .room-header button{
      border:none;padding:6px 12px;border-radius:6px;
      background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;
      cursor:pointer;white-space:nowrap;
    }

    /* Messages */
   #messages {
  flex: 1; /* fill available vertical space */
  overflow-y: auto; /* enable vertical scroll */
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  background: radial-gradient(#6dddd4);
  scroll-behavior: smooth; /* smooth scroll on new messages */
  padding-bottom: 80px; /* space for composer */
}

  .message {
max-width: 85%;
padding: 12px 16px;
border-radius: 16px;
line-height: 1.4;
word-wrap: break-word;
backdrop-filter: blur(8px);
box-shadow: 0 4px 10px rgba(0,0,0,0.3);
font-size: 15px;
}
.message.emoji {
  font-size: 22px;
  text-align: left;
  background: transparent;
  box-shadow: none;
}
.message .meta {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 4px;
}

  .message.other {
align-self: flex-start;
color: hsl(244, 85%, 10%);
border-bottom-left-radius: 4px;

/* Glassy water effect */
background: rgba(255, 255, 255, 0.15); /* translucent */
backdrop-filter: blur(12px) saturate(180%);
-webkit-backdrop-filter: blur(12px) saturate(180%);

border: 1px solid rgba(255, 255, 255, 0.3);
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);

  /* optional glossy gradient overlay */
  background-image: linear-gradient(
    to top left,
    rgba(255, 255, 255, 0.25),
    rgba(255, 255, 255, 0.05)
  );
}

    .message.me {
  align-self: flex-end;
  color: hsl(238, 93%, 5%);
  border-bottom-right-radius: 4px;

  /* Glassy water effect with dark tint */
  background: rgba(137, 137, 208, 0.3); /* darker glass tint */
  backdrop-filter: blur(12px) saturate(200%);
  -webkit-backdrop-filter: blur(12px) saturate(200%);

  border: 1px solid rgba(255, 255, 255, 0.25);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);

  /* glossy highlight */
  background-image: linear-gradient(
    to top left,
    rgba(255, 255, 255, 0.2),
    rgba(255, 255, 255, 0.05)
  );
}


    /* Composer */
   .composer {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  display: flex;
  gap: 25px;
  padding: 6px;
  background: rgba(30, 30, 60, 0.95);
  border-top: 1px solid rgba(255,255,255,0.1);
  z-index: 1000;
}

.composer textarea {
  flex: 1;
  padding: 10px 10px;
  border-radius: 18px;
  border: none;
  resize: none;
  background: rgba(255,255,255,0.1);
  color: #fff;
  min-height: 40px;     /* ‚úÖ avoids zoom */
  font-size: 16px;      /* ‚úÖ avoids zoom on iOS */
  line-height: 1;
  overflow-y: auto;
}

.composer button {
  padding: 0 16px;
  border: none;
  border-radius: 20px;
  background: linear-gradient(135deg, var(--accent1), var(--accent2));
  color: #fff;
  font-weight: 800;
  cursor: pointer;
  min-width: 7px;
}
    /* Responsive tweaks */
    @media(max-width:600px){
      .message{max-width:85%;font-size:15px;}
      .setup input, .setup button{flex:1 1 100%; margin-bottom:6px;}
      .composer textarea{min-height:50px;}
      header h1{font-size:1em;}
    }

    /* Header container */
.header-top {
  display: flex;
  align-items: center;
  justify-content: space-between; /* Push logo left, button right */
  padding: 10px 10px;
  background: linear-gradient(#263f75);
  box-shadow: 0 2px 10px rgba(0,0,0,0.5);
  flex-wrap: wrap; /* Wrap on very small screens */
  gap: 10px;
}

/* Logo */
.chat-logo {
  width: 40px;
  height: 40px;
  object-fit: contain;
}

/* Chatroom Link */
.chatroom-link {
  font-size: 2em;
  font-weight: 700;
  text-decoration: none;
  background: linear-gradient(#e0e0e7);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  white-space: nowrap;
  transition: all 0.3s ease;
}

.chatroom-link:hover {
  transform: scale(1.05);
  text-shadow: 0 0 6px rgba(255,255,255,0.6);
}

/* Instructions Button */
#instructions-btn {
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  background: linear-gradient(135deg,#6366f1,#3b82f6);
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;
  transition: transform 0.2s;
}

#instructions-btn:hover {
  transform: scale(1.05);
}

/* Responsive tweaks */
@media (max-width: 600px) {
  .header-top {
    justify-content: center;
    gap: 15px;
  }

  .chat-logo {
    width: 32px;
    height: 32px;
  }

  .chatroom-link {
    font-size: 1em;
  }

  #instructions-btn {
    padding: 10px 10px;
    font-size: 0.9em;
  }
}
/* Invite Modal Styles */
.invite-modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  display: none;
  justify-content: center;
  align-items: center;
  background: rgba(0, 0, 0, 0.6);
  z-index: 2000;
  backdrop-filter: blur(4px);
}

.invite-modal.show {
  display: flex;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {opacity: 0;}
  to {opacity: 1;}
}

.invite-box {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 14px;
  padding: 20px;
  width: 90%;
  max-width: 400px;
  text-align: center;
  box-shadow: 0 6px 18px rgba(0,0,0,0.3);
  animation: popUp 0.25s ease;
}

@keyframes popUp {
  from {transform: scale(0.9); opacity: 0;}
  to {transform: scale(1); opacity: 1;}
}

.invite-box h3 {
  margin-top: 0;
  color: #202a44;
  font-weight: 700;
}

#invite-message {
  width: 100%;
  height: 60px;
  margin: 10px 0;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 8px;
  resize: none;
  font-size: 14px;
}

#invite-link {
  width: 100%;
  border: 1px solid #bbb;
  border-radius: 6px;
  padding: 8px;
  font-size: 13px;
  background: #f3f3f3;
  color: #333;
}

.invite-actions {
  display: flex;
  justify-content: space-between;
  margin-top: 12px;
}

.invite-actions button {
  flex: 1;
  margin: 0 4px;
  border: none;
  border-radius: 8px;
  padding: 10px;
  font-weight: 700;
  cursor: pointer;
  transition: 0.2s ease;
}

#copy-link-btn {
  background: linear-gradient(135deg, #00c6ff, #0072ff);
  color: #fff;
}
#copy-link-btn:hover {
  transform: scale(1.05);
}

#close-invite-btn {
  background: #eee;
  color: #333;
}
#close-invite-btn:hover {
  background: #ddd;
}
/* Personalized Welcome Popup */
.welcome-popup {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.6);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 3000;
  backdrop-filter: blur(6px);
}

.welcome-popup.show {
  display: flex;
  animation: fadeIn 0.3s ease;
}

.welcome-box {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 14px;
  padding: 24px;
  width: 90%;
  max-width: 420px;
  text-align: center;
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  animation: popUp 0.25s ease;
}

.welcome-box h2 {
  margin-top: 0;
  color: #202a44;
}

.welcome-box p {
  color: #333;
  font-size: 15px;
}

.welcome-box button {
  margin-top: 14px;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  background: linear-gradient(135deg, var(--accent1), var(--accent2));
  color: white;
  font-weight: 700;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.welcome-box button:hover {
  transform: scale(1.05);
}
  </style>
</head>
<body>
 <script>
  // Array of light gradient options (same as original)
  const gradients = [
    "radial-gradient(circle at center, #fdfbfb, #ebedee)",
    "radial-gradient(circle at center, #f6d365, #fda085)",
    "radial-gradient(circle at center, #a1c4fd, #c2e9fb)",
    "radial-gradient(circle at center, #d4fc79, #96e6a1)",
    "radial-gradient(circle at center, #fbc2eb, #a6c1ee)",
    "radial-gradient(circle at center, #ffecd2, #fcb69f)",
    "radial-gradient(circle at center, #cfd9df, #e2ebf0)",
    "radial-gradient(circle at center, #e0c3fc, #8ec5fc)",
    "radial-gradient(circle at center, #f9f586, #a6e7ff)",
    "radial-gradient(circle at center, #ffdde1, #ee9ca7)",
    "radial-gradient(circle at center, #c2e9fb, #e2fcff)",
    "radial-gradient(circle at center, #fdfbfb, #dfe9f3)",
    "radial-gradient(circle at center, #f8e2cf, #f1f2b5)",
    "radial-gradient(circle at center, #f6f0c4, #d0e6a5)",
    "radial-gradient(circle at center, #e0c3fc, #f9f9f9)",
    "radial-gradient(circle at center, #e8cbc0, #636fa4)",
    "radial-gradient(circle at center, #ffefba, #ffffff)",
    "radial-gradient(circle at center, #a1ffce, #faffd1)",
    "radial-gradient(circle at center, #d9afd9, #97d9e1)",
    "radial-gradient(circle at center, #fff1eb, #ace0f9)",
    "radial-gradient(circle at center, #ffd1ff, #f5c7f7)",
    "radial-gradient(circle at center, #ff9a9e, #fecfef)",
    "radial-gradient(circle at center, #f6d365, #fda085)",
    "radial-gradient(circle at center, #fbc2eb, #a6c1ee)",
    "radial-gradient(circle at center, #cfd9df, #e2ebf0)",
    "radial-gradient(circle at center, #e0c3fc, #8ec5fc)",
    "radial-gradient(circle at center, #d4fc79, #96e6a1)",
    "radial-gradient(circle at center, #fbc2eb, #f9c6e0)",
    "radial-gradient(circle at center, #a8edea, #fed6e3)",
    "radial-gradient(circle at center, #f5f7fa, #c3cfe2)",
    "radial-gradient(circle at center, #fdfcfb, #e2d1c3)",
    "radial-gradient(circle at center, #f1f2b5, #135058)",
    "radial-gradient(circle at center, #fffcdc, #d9a7c7)",
    "radial-gradient(circle at center, #a6c0fe, #f68084)",
    "radial-gradient(circle at center, #fccb90, #d57eeb)",
    "radial-gradient(circle at center, #fddb92, #d1fdff)",
    "radial-gradient(circle at center, #9890e3, #b1f4cf)",
    "radial-gradient(circle at center, #fff6b7, #f6416c)",
    "radial-gradient(circle at center, #e0c3fc, #f9c5d1)",
    "radial-gradient(circle at center, #cfd9df, #a6c1ee)",
    "radial-gradient(circle at center, #d299c2, #fef9d7)",
    "radial-gradient(circle at center, #fddb92, #d1fdff)",
    "radial-gradient(circle at center, #fceabb, #f8b500)",
    "radial-gradient(circle at center, #d9a7c7, #fffcdc)",
    "radial-gradient(circle at center, #f6d365, #fda085)",
    "radial-gradient(circle at center, #ffecd2, #fcb69f)",
    "radial-gradient(circle at center, #ffdde1, #ee9ca7)",
    "radial-gradient(circle at center, #ff9a9e, #fecfef)",
    "radial-gradient(circle at center, #cfd9df, #e2ebf0)",
    "radial-gradient(circle at center, #a1c4fd, #c2e9fb)",
    "radial-gradient(circle at center, #fbc2eb, #a6c1ee)",
    "radial-gradient(circle at center, #fdfbfb, #ebedee)",
    "radial-gradient(circle at center, #d4fc79, #96e6a1)",
    "radial-gradient(circle at center, #fff1eb, #ace0f9)"
  ];

  const randomGradient = gradients[Math.floor(Math.random() * gradients.length)];

  document.addEventListener("DOMContentLoaded", () => {
    const messages = document.getElementById("messages");
    if (messages) messages.style.background = randomGradient;
  });
</script>

<div class="container">
 <header class="header-top">
  <img src="logochat.png" alt="Chat Logo" class="chat-logo">
  <a href="https://hematics43.github.io/ChatRoom/" id="chatroom-link" class="chatroom-link">>>>Chatüì¢Room<<<</a>
  <button id="instructions-btn">‚öôÔ∏èInstruction</button>
</header>

 <div id="instructions">
  <h2>üìñ How to Use ChatRoom >>></h2>
  <ol>
   <li>üîë Enter a <b>Room Code</b> & <b>Nickname</b>, then click <b>Join</b>.</li>
    <li>üé≤ Or click <b>Generate Room</b> to make a new one & share it.</li>
    <li>üí¨ Chat instantly ‚Äî your messages are on the right, others on the left.</li>
    <li>üßπ Use <b>üíæ as Download chats</b>, <b>üóëÔ∏è as Clear all chats</b>,<b>üîö as Exit chat room</b></li>
    <li>‚ö†Ô∏è Note: Rooms are always active. If everyone leaves, the chat history will be in room. And send only short messages</li>
  </ol>
</div>

  <div class="setup" id="setup">
    <input id="room-input" type="text" placeholder="Room Code"/>
    <input id="name-input" type="text" placeholder="Nickname"/>
    <button id="join-btn">ü§ùJoin</button>
    <button id="gen-btn">ü§ñGenerate Room</button>
  </div>

  <div class="room-header" id="room-display" style="display:none;">
    <span id="room-code-text"></span>
    <button id="download-btn" style="display:none;">üíæ</button>
    <button id="clear-btn">üóëÔ∏è</button>
    <button id="leave-btn">üîö</button>
    <button id="sound-btn">üîä</button>
    <button id="invite-btn">X</button>
  </div>

  <div id="messages"></div>

  <div class="composer">
    <textarea id="msg-input" placeholder="Write here..." disabled></textarea>
    <button id="send-btn" disabled>‚ï∞‚îà‚û§</button>
  </div>

<div id="invite-modal" class="invite-modal">
  <div class="invite-box">
    <h3>üîó Share Room Invitation</h3>
    <p>Your room code: <strong id="invite-room-code"></strong></p>
    <textarea id="invite-message" placeholder="Write a short message...">Feature is coming Soon...</textarea>
    <input id="invite-link" type="text" readonly />
    <div class="invite-actions">
      <button id="copy-link-btn">üìã Copy Link</button>
      <button id="close-invite-btn">‚ùå Close</button>
    </div>
  </div>
</div>

<div id="welcome-popup" class="welcome-popup">
  <div class="welcome-box">
    <h2 id="welcome-title">üëã Welcome!</h2>
    <p id="welcome-message">Let‚Äôs get started üéâ</p>
    <button id="welcome-ok-btn">Let‚Äôs Go üöÄ</button>
  </div>
</div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getDatabase,
    ref,
    push,
    onChildAdded,
    remove,
    set,
    off
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  // Elements & state
  const inviteBtn = document.getElementById("invite-btn");
  const inviteModal = document.getElementById("invite-modal");
  const inviteRoomCode = document.getElementById("invite-room-code");
  const inviteMessage = document.getElementById("invite-message");
  const inviteLink = document.getElementById("invite-link");
  const copyLinkBtn = document.getElementById("copy-link-btn");
  const closeInviteBtn = document.getElementById("close-invite-btn");
  let activeRoom = null;
  let nickname = null;
  let messagesRef = null; // store ref so we can detach listener on leave
  let childAddedCallback = null;

  // Welcome popup
  const welcomePopup = document.getElementById("welcome-popup");
  const welcomeTitle = document.getElementById("welcome-title");
  const welcomeMessageEl = document.getElementById("welcome-message");
  const welcomeOkBtn = document.getElementById("welcome-ok-btn");

  function showWelcomeOnce(name, room) {
    const visitKey = `welcomed_${room}_${name}`;
    if (!localStorage.getItem(visitKey)) {
      welcomeTitle.textContent = `üëã Welcome, ${name}`;
      welcomeMessageEl.textContent = `You‚Äôve joined room #${room} ‚Äî enjoy chatting üéâ (Educational Purpose) Double tap üëã`;
      welcomePopup.classList.add("show");
      localStorage.setItem(visitKey, "true");
    }
  }
  welcomeOkBtn.onclick = () => welcomePopup.classList.remove("show");

  // Invite modal behavior
  inviteBtn.onclick = () => {
    if (!activeRoom) return alert("Join a room first!");
    const baseUrl = window.location.origin + window.location.pathname;
    const link = `${baseUrl}?room=${encodeURIComponent(activeRoom)}&msg=${encodeURIComponent(inviteMessage.value)}`;
    inviteRoomCode.textContent = activeRoom;
    inviteLink.value = link;
    inviteModal.classList.add("show");
  };
  inviteMessage.addEventListener("input", () => {
    if (!activeRoom) return;
    const baseUrl = window.location.origin + window.location.pathname;
    inviteLink.value = `${baseUrl}?room=${encodeURIComponent(activeRoom)}&msg=${encodeURIComponent(inviteMessage.value)}`;
  });
  copyLinkBtn.onclick = async () => {
    try {
      await navigator.clipboard.writeText(inviteLink.value);
      copyLinkBtn.textContent = "‚úÖ Copied!";
      setTimeout(() => copyLinkBtn.textContent = "üìã Copy Link", 2000);
    } catch {
      alert("Could not copy the link. Please copy it manually.");
    }
  };
  closeInviteBtn.onclick = () => inviteModal.classList.remove("show");
  inviteModal.onclick = e => { if (e.target === inviteModal) inviteModal.classList.remove("show"); };

  // Firebase config (unchanged)
  const firebaseConfig = {
    apiKey: "AIzaSyAKUkKJLa1XSV4NwjFBrG2M2g3ObkE5CbI",
    authDomain: "code-chatroom.firebaseapp.com",
    projectId: "code-chatroom",
    storageBucket: "code-chatroom.appspot.com",
    messagingSenderId: "207673617291",
    appId: "1:207673617291:web:d25bfef5658e6504acdd8e",
    databaseURL: "https://code-chatroom-default-rtdb.asia-southeast1.firebasedatabase.app/"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Sound
  const popSound = new Audio("pop.wav");
  popSound.volume = 0.4;

  // Unlock play on first click (autoplay policy)
  window.addEventListener("click", () => {
    popSound.play().catch(() => {});
    popSound.pause();
    popSound.currentTime = 0;
  }, { once: true });

  function playPopSound() {
    if (!soundEnabled) return;
    const clone = popSound.cloneNode();
    clone.volume = popSound.volume;
    clone.play().catch(() => {});
  }

  // Elements
  const setup = document.getElementById("setup");
  const roomInput = document.getElementById("room-input");
  const nameInput = document.getElementById("name-input");
  const joinBtn = document.getElementById("join-btn");
  const genBtn = document.getElementById("gen-btn");
  const roomDisplay = document.getElementById("room-display");
  const roomCodeText = document.getElementById("room-code-text");
  const downloadBtn = document.getElementById("download-btn");
  const messagesEl = document.getElementById("messages");
  const msgInput = document.getElementById("msg-input");
  const sendBtn = document.getElementById("send-btn");
  const instrBtn = document.getElementById("instructions-btn");
  const instructions = document.getElementById("instructions");
  const leaveBtn = document.getElementById("leave-btn");
  const clearBtn = document.getElementById("clear-btn");
  const soundBtn = document.getElementById("sound-btn");
  let soundEnabled = true;

  const quickEmojis = ["üëã"];

  instrBtn.onclick = () => {
    instructions.classList.toggle("open");
    instrBtn.textContent = instructions.classList.contains("open") ? "Hide Instructions" : "Instructions";
  };

  // Render message function (clean, handles system messages separately)
  function renderMessage(data) {
    if (!data) return;
    // System messages
    if (data.name === "üì¢ System") {
      const sysEl = document.createElement("div");
      sysEl.classList.add("system-msg");
      sysEl.textContent = data.text;
      messagesEl.appendChild(sysEl);
      messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: "smooth" });
      return;
    }

    const msg = document.createElement("div");
    const cls = "message " + (data.name === nickname ? "me" : "other") + (data.type === "emoji" ? " emoji" : "");
    msg.className = cls;
    const time = data.createdAt ? new Date(data.createdAt).toLocaleString() : "";
    const safeText = (data.text || "").toString();
    msg.innerHTML = `<div class="meta">${(data.name || "Anon")} ¬∑ ${time}</div><div class="body">‚ï∞‚û§ ${safeText}</div>`;
    messagesEl.appendChild(msg);

    // Auto-scroll if near bottom
    const nearBottom = messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight < 150;
    if (nearBottom) {
      messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: "smooth" });
    }

    // Play sound for others' messages
    if (data.name !== nickname && soundEnabled) playPopSound();
  }

  // Add message listener
  function attachListener(room) {
    if (!room) return;
    messagesRef = ref(db, `messages/${room}`);
    childAddedCallback = (snapshot) => {
      const data = snapshot.val();
      renderMessage(data);
    };
    onChildAdded(messagesRef, childAddedCallback);
  }

  // Remove listener
  function detachListener() {
    if (messagesRef && childAddedCallback) {
      off(messagesRef, "child_added", childAddedCallback);
      messagesRef = null;
      childAddedCallback = null;
    }
  }

  // Join room (improved)
  async function joinRoom(room) {
    activeRoom = room;
    nickname = nameInput.value.trim() || "USER:";
    localStorage.setItem("chatroom", activeRoom);
    localStorage.setItem("nickname", nickname);

    messagesEl.innerHTML = "";
    setup.style.display = "none";
    roomDisplay.style.display = "flex";
    roomCodeText.innerHTML = `Room Code: <span>${activeRoom}</span>`;
    downloadBtn.style.display = "inline-block";
    msgInput.disabled = false;
    sendBtn.disabled = false;

    // show welcome only first time in this room for this name
    showWelcomeOnce(nickname, activeRoom);

    // detach any previous listener just in case
    detachListener();

    // attach new listener
    attachListener(activeRoom);

    // Post a single "joined" system message (do NOT place inside onChildAdded)
    try {
      const sysRef = push(ref(db, `messages/${activeRoom}`));
      await set(sysRef, {
        name: "üì¢ System",
        text: `${nickname} joined the room`,
        createdAt: Date.now()
      });
    } catch (err) {
      console.warn("Failed to post join system message:", err);
    }
  }

  joinBtn.onclick = () => { if (roomInput.value.trim()) joinRoom(roomInput.value.trim()); };
  genBtn.onclick = () => {
    const code = Math.random().toString(36).substring(2, 8).toUpperCase();
    roomInput.value = code; joinRoom(code);
  };

  // restore session if exists
  window.addEventListener("load", () => {
    const savedRoom = localStorage.getItem("chatroom");
    const savedName = localStorage.getItem("nickname");
    if (savedRoom && savedName) {
      roomInput.value = savedRoom;
      nameInput.value = savedName;
      joinRoom(savedRoom);
    }
  });

  // send message
  sendBtn.onclick = async () => {
    if (!msgInput.value.trim() || !activeRoom) return;
    try {
      const refToPush = ref(db, `messages/${activeRoom}`);
      await push(refToPush, {
        name: nickname,
        text: msgInput.value.trim(),
        type: "text",
        createdAt: Date.now()
      });
      msgInput.value = "";
    } catch (err) {
      console.error("Failed to send message:", err);
    }
  };

  // double-tap messages area => send emoji
  messagesEl.addEventListener("dblclick", async () => {
    if (!activeRoom || !nickname) return;
    const emoji = quickEmojis[Math.floor(Math.random() * quickEmojis.length)];
    const refToPush = ref(db, `messages/${activeRoom}`);
    await push(refToPush, {
      name: nickname,
      text: emoji,
      type: "emoji",
      createdAt: Date.now()
    });
  });

  // Enter = send
  msgInput.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });

  // Download chat
  downloadBtn.onclick = () => {
    let chatText = `Chatroom: ${activeRoom}\n====================\n\n`;
    messagesEl.querySelectorAll(".message, .system-msg").forEach(node => {
      if (node.classList.contains("system-msg")) {
        chatText += `[SYSTEM] ${node.textContent}\n\n`;
      } else {
        const meta = node.querySelector(".meta")?.textContent || "";
        const body = node.querySelector(".body")?.textContent || node.innerText.replace(meta, "").trim();
        chatText += `${meta}\n${body}\n\n`;
      }
    });
    const blob = new Blob([chatText], { type: "text/plain" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `chatroom-${activeRoom}.txt`;
    link.click();
  };

  // Clear chat (remove from db)
  clearBtn.onclick = async () => {
    if (!activeRoom) return;
    if (confirm("Are you sure you want to clear all messages in this room?")) {
      try {
        await remove(ref(db, `messages/${activeRoom}`));
        messagesEl.innerHTML = "";
      } catch (err) {
        console.error("Failed to clear messages:", err);
      }
    }
  };

  // Leave chatroom: remove local state and listener, post left system message
  leaveBtn.onclick = async () => {
    if (activeRoom && nickname) {
      try {
        const sysRef = push(ref(db, `messages/${activeRoom}`));
        await set(sysRef, {
          name: "üì¢ System",
          text: `${nickname} left the room`,
          createdAt: Date.now()
        });
      } catch (err) {
        console.warn("Failed to post leave system message:", err);
      }
    }
    localStorage.removeItem("chatroom");
    localStorage.removeItem("nickname");
    activeRoom = null;
    nickname = null;
    detachListener();
    messagesEl.innerHTML = "";
    setup.style.display = "flex";
    roomDisplay.style.display = "none";
    msgInput.disabled = true;
    sendBtn.disabled = true;
  };

  // Sound toggle
  soundBtn.onclick = () => {
    soundEnabled = !soundEnabled;
    soundBtn.textContent = soundEnabled ? "üîä" : "üîá";
  };

  // Post system message on page unload? (optional - not required)
  window.addEventListener("beforeunload", async () => {
    // do not try to call Firebase on unload (may be unreliable). leaving out by design.
  });

</script>
</body>
</html>
